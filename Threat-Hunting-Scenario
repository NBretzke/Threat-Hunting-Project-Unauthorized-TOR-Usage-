---

# Tor Project

<img width="400" src="https://github.com/user-attachments/assets/44bac428-01bb-4fe9-9d85-96cba7698bee" alt="Tor Logo with the onion and a crosshair on it"/>

# Threat Hunt Report: Unauthorized TOR Usage
- [Scenario Creation](https://github.com/NBretzke/Threat-Hunting-Project-Unauthorized-TOR-Usage-/blob/main/ThreatHuntCreation)

---

## Platforms and Languages Leveraged
- Windows 10 Virtual Machines (Microsoft Azure)
- SIEM: Microsoft Sentinel
- EDR Platform: Microsoft Defender for Endpoint
- Kusto Query Language (KQL)
- Tor Browser

---

## Scenario

Management suspects that employees may be using TOR browsers to bypass organizational security controls after unusual encrypted traffic patterns and connections to known TOR entry nodes were observed. Anonymous reports also suggested employees were discussing methods to access restricted websites during work hours.

The objective of this threat hunt was to detect any unauthorized TOR usage, analyze correlated endpoint and network activity, and take appropriate response actions if confirmed.

---

## High-Level TOR-Related IoC Discovery Plan

- Identify TOR-related **file artifacts** on endpoints
- Detect **process execution** associated with TOR installation and usage
- Confirm **network connections** over known TOR ports
- Correlate all findings into a single investigative dataset

---

## Detection & Investigation Methodology

A single **correlated KQL query** was used to unify telemetry from:

- `DeviceFileEvents`
- `DeviceProcessEvents`
- `DeviceNetworkEvents`

This correlation-first approach reflects real SOC detection engineering practices.

---

## Correlated Hunt Query (Union)

```kql
union
(
    DeviceFileEvents
    | where FileName has_any ("tor", "onion", "firefox")
    | project Timestamp, DeviceName, ActionType, FileName, FolderPath, SHA256,
              Account = InitiatingProcessAccountName
),
(
    DeviceProcessEvents
    | where FileName has_any ("tor.exe", "firefox.exe", "tor-browser.exe")
        or ProcessCommandLine has_any ("tor-browser-windows", "Tor Browser")
    | project Timestamp, DeviceName, ActionType, FileName, FolderPath, SHA256,
              Account = AccountName, ProcessCommandLine
),
(
    DeviceNetworkEvents
    | where InitiatingProcessFileName has_any ("tor.exe", "firefox.exe")
    | where RemotePort in (9001, 9030, 9040, 9050, 9051, 9150, 80, 443)
    | project Timestamp, DeviceName, ActionType, RemoteIP, RemotePort, RemoteUrl,
              Account = InitiatingProcessAccountName,
              InitiatingProcessFileName, InitiatingProcessFolderPath
)
| order by Timestamp desc
